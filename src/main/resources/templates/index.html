<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
	<meta charset="utf-8">
	<title>Vivero</title>


	
	<!--CSS-->
<!-- 	<link rel="stylesheet" href="../static/css/estilos2.css" th:href="@{/css/estilos.css}"> -->
	<link rel="stylesheet" href="../static/css/estilos2.css" th:href="@{/css/estilos2.css}">
	
	
	<!-- Bootstrap CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

	<!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script> -->

	<!-- Links iconos bootstrap -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.0/font/bootstrap-icons.css">

	<!-- Links fuentes-->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">

</head>

<body style="background-image:url(../img/fondo01.jpg);">
	<nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top    ">
		<div class="container-fluid">
			<a class="navbar-brand" href="/">OREVIV</a>
			<div style="display:flex">
				<form class="d-flex mx-1 d-lg-none">
					<input class="form-control me-2" type="search" placeholder="Buscar" aria-label="Search">
					<button class="btn btn-outline-success" type="submit"><i class="bi bi-search"></i>
					</button>
				</form>
				<button class="btn btn-outline-success mx-1 d-lg-none" type="submit"><i class="bi bi-cart-fill"></i>
				</button>
				<button class="navbar-toggler" type="button" data-bs-toggle="collapse"
					data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
					aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
				</button>
			</div>

			<div class="collapse navbar-collapse" id="navbarSupportedContent">
				<ul class="navbar-nav me-auto mb-2 mb-lg-0">
					<li class="nav-item">
						<a class="nav-link active" aria-current="page" href="/planta/consultaPlanta">Plantas</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="/maceta/consultaMaceta">Macetas</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="/accesorio/consultaAccesorio">Accesorios</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#">Tendencias</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#">Nosotros</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#">Contacto</a>
					</li>
				</ul>
				<div class="p-2 bd-highlight d-none d-lg-flex">
					<form class="d-flex mx-1">
						<input class="form-control me-2" type="search" placeholder="Buscar" aria-label="Search">
						<button class="btn btn-outline-success" type="submit"><i class="bi bi-search"></i>
						</button>
					</form>
					<button class="btn btn-outline-success mx-1" type="submit"><i class="bi bi-cart-fill"></i>
					</button>
				</div>
			</div>
		</div>
	</nav>
	<main>
		<div id="carouselExampleIndicators" class="carousel slide" data-bs-ride="carousel">
			<div class="carousel-indicators">
				<button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="0" class="active"
					aria-current="true" aria-label="Slide 1"></button>
				<button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="1"
					aria-label="Slide 2"></button>
				<button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="2"
					aria-label="Slide 3"></button>
			</div>
			<div class="carousel-inner">
				<div class="carousel-item active">
					<img src="../img/carrete01.jpg" class="d-block w-100" alt="...">
				</div>
				<div class="carousel-item">
					<img src="../img/carrete02.jpg" class="d-block w-100" alt="...">
				</div>
				<div class="carousel-item">
					<img src="../img/carrete01.jpg" class="d-block w-100" alt="...">
				</div>
			</div>
			<button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators"
				data-bs-slide="prev">
				<span class="carousel-control-prev-icon" aria-hidden="true"></span>
				<span class="visually-hidden">Previous</span>
			</button>
			<button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators"
				data-bs-slide="next">
				<span class="carousel-control-next-icon" aria-hidden="true"></span>
				<span class="visually-hidden">Next</span>
			</button>
		</div>

		<div class="divisor">
			<h1 class="animacion" style="color: white; text-align: center;">PRODUCTOS DESTACADOS</h1>
		</div>

		<div class="row">
			<div class="col-3 m-0 p-0 imgWrap" th:each="planta : ${plantasFiltradas} " style="height:45vh;">
				<img class=" w-100  img-fluid" th:src="'/imagen/planta/'+*{planta.id}" alt="" style="height:45vh;" />
				<div class="info" th:id="'info'+*{planta.id}">
					<a href="#" class="text-decoration-none parent">
						<p class="nombre_text text-decoration-none text-white px-5 py-10  lh-1" th:text=${planta.nombre}
							style="">PETUNIA</p>
					</a>
					<p class="precio_text" th:text=${planta.precio}>$800</p>
					<p class="stock_text invisible" th:text=${planta.stock}>2</p>
					<button type="button" id="compraBoton" th:id="*{planta.id}" class="btW btn-light child compraBoton">
						COMPRAR
					</button>
				</div>
			</div>
		</div>

		<div class=" divisor ">

		</div>

	</main>

	<script src=" https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js "
		integrity=" sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p "
		crossorigin=" anonymous "></script>
	<script src=" https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js "></script>
	<script>
		$('.child').click(function (e) {
			if (!e) var e = window.event;
			e.cancelBubble = true;
			if (e.stopPropagation) e.stopPropagation();
		});
		$('.parent').click(function (e) {
		});

		$('.compraBoton').click(function () {
			var botonId = $(this).attr('id');
			var nombre = $(" #nombre").text();
			var precio = $("#precio").text();
			var stock = $("#stock").text();
			addtocart(botonId, nombre, precio, stock);
		});

		function addtocart(pid, nombre, precio,
			stock) { // var quantity=$("#quantity").val() !="" ? parseInt($("#quantity").val()) : 0; var
			quantity = $("#contador").text() != "" ? parseInt($("#contador").text()) : 1;
			stock = checkRemainingStock(stock, quantity, pid);
			var cart = localStorage.getItem("cart");
			var pcart = JSON.parse(cart) != null ? JSON.parse(cart) : [];
			// si el cart esta vacia inicializa uin array vacio //get index of the json array where the productid is there ...
			var present_or_not = pcart.findIndex(item => item.productid == pid);
			//if the item not presnt , is null
			// si el producto no existe lo agregamos al cart
			if (cart == null || present_or_not == null || present_or_not == -1) {
				var product = {
					productid: pid,
					nombre: nombre,
					precio: precio,
					stock: stock,
					quantity: quantity
				};
				pcart.push(product);
				localStorage.setItem("cart", JSON.stringify(pcart));
			} else {
				//get the the json from index...
				var actual_stored_product = pcart[present_or_not];
				pcart.splice(present_or_not, 1); //remove the json object array
				//get the qty which was already prsnt
				var actual_qty = actual_stored_product.quantity == null || actual_stored_product.quantity == "" ? 0 : actual_stored_product.quantity;
				//update the value
				actual_stored_product.quantity = parseInt(actual_qty) + quantity;
				actual_stored_product.stock = parseInt(stock);
				//now..we have updated value..push obj again..
				pcart.push(actual_stored_product);
				//store the json in local Storage
				localStorage.setItem("cart", JSON.stringify(pcart));
			}
			console.log(JSON.stringify(pcart));
			// updatecart();
		}

		$('#cartButton').click(function () {
			cartPreview();
		})

		var cartPreview = function () {
			var cart = localStorage.getItem("cart");
			var pcart = JSON.parse(cart) != null ? JSON.parse(cart) : [];
			$('#cartTableBody').empty();
			if (cart) {
				var contador = 1;
				var total = 0;
				pcart.forEach(producto => {
					console.log('producto: ', producto);
					var cant = parseInt(producto.quantity, 10);

					var precio = parseInt(producto.precio, 10);

					total += cant * precio;

					var tr = $($.parseHTML('<tr>')).attr('id', 'prod' + producto.productid);
					var tdContador = $($.parseHTML('<td>')).text(contador);
					var tdNombre = $($.parseHTML(' < td > ')).text(producto.nombre);
					var tdPrecio = $($.parseHTML(' < td > ')).text(producto.precio);
					var tdCant = $($.parseHTML(' < td > ')).text(producto.quantity);
					var tdSubtotal = $($.parseHTML(' < td > ')).text(cant * precio);
					var quitarProducto = $($.parseHTML(' < td > ')).append(' < button id = "delete' + producto.productid + '"class= " btn bi bi-trash borrarBoton" ></i ></button > ');

					tr.append(tdContador);
					tr.append(tdNombre);
					tr.append(tdCant);
					tr.append(tdPrecio);
					tr.append(tdSubtotal);
					tr.append(quitarProducto);

					$('#cartTableBody').append(tr);

					contador++;
				});
				$('#cartTotal').text('$' + total);
			}
			$('.borrarBoton').click(function () {
				console.log('delete');
				var productId = $(this).attr('id').slice(6);;
				console.log('elementoInfoId: ' + productId);
				$('#prod' + productId).remove();

				var cart = localStorage.getItem("cart");
				var pcart = JSON.parse(cart) != null ? JSON.parse(cart) : [];
				var index = pcart.findIndex(item => item.productid == productId);
				pcart.splice(index, 1);
				localStorage.setItem("cart", JSON.stringify(pcart));
			});
		};

		var checkRemainingStock = function (stock, qty, pid) {
			console.log('stock: ' + stock);
			console.log('qty: ' + qty);

			stock -= qty;
			$("#stock").text(stock);
			$("#aumentar").attr('max', stock);
			if (stock <= 0) {
				$(".compraBoton").remove();
				var buttonSinStockContador = $($.parseHTML('<button>')).text('Sin Mas Stock');
				buttonSinStockContador.prop('disabled', true);

				buttonSinStockContador.addClass(['btn', 'btn-outline-success']);
				$("#contenedorCompraBoton").append(buttonSinStockContador);
			}
			return stock;
		}

	</script>

</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js "
	integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p "
	crossorigin="anonymous "></script>

<script src="../static/js/app.js " th:src="@{/js/app.js} "></script>

</html>